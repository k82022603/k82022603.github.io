name: Publish Wiki to Chirpy (Advanced)

on:
  push:
    branches: [ main ]

jobs:
  wiki-to-blog:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Clone Wiki
      run: |
        git clone https://github.com/k82022603/k82022603.github.io.wiki.git wiki

    - name: Convert Wiki to Chirpy posts
      run: |
        mkdir -p _posts _drafts
        NOW_TZ="+0900"

        for file in wiki/*.md; do
          TITLE=$(grep -m 1 "^# " "$file" | sed 's/^# //')
          [ -z "$TITLE" ] && continue

          PUBLISH=$(grep "^@publish:" "$file" | awk '{print $2}')
          [ "$PUBLISH" = "false" ] && continue

          SLUG=$(grep "^@slug:" "$file" | awk '{print $2}')
          [ -z "$SLUG" ] && SLUG=$(echo "$TITLE" | tr '[:upper:]' '[:lower:]' | sed 's/ /-/g')

          WIKI_DATE=$(grep "^@date:" "$file" | awk '{print $2}')
          if [ -z "$WIKI_DATE" ]; then
            POST_DATE=$(date +"%Y-%m-%d")
            POST_DATETIME=$(date +"%Y-%m-%d %H:%M:%S $NOW_TZ")
          else
            POST_DATE="$WIKI_DATE"
            POST_DATETIME="$WIKI_DATE 09:00:00 $NOW_TZ"
          fi

          CATEGORIES=$(grep "^@categories:" "$file" | cut -d':' -f2 | sed 's/,/, /g')
          TAGS=$(grep "^@tags:" "$file" | cut -d':' -f2 | sed 's/,/, /g')
          DRAFT=$(grep "^@draft:" "$file" | awk '{print $2}')

          if [ "$DRAFT" = "true" ]; then
            TARGET="_drafts/${SLUG}.md"
          else
            TARGET="_posts/${POST_DATE}-${SLUG}.md"
          fi

          echo "---" > "$TARGET"
          echo "title: \"$TITLE\"" >> "$TARGET"
          echo "date: $POST_DATETIME" >> "$TARGET"
          echo "categories: [$CATEGORIES]" >> "$TARGET"
          echo "tags: [$TAGS]" >> "$TARGET"
          echo "---" >> "$TARGET"
          echo "" >> "$TARGET"

          sed '/^@/d;/^#/d' "$file" >> "$TARGET"
        done

    - name: Commit & Push
      run: |
        git config user.name "github-actions"
        git config user.email "actions@github.com"

        git fetch origin main
        git reset --hard origin/main

        git add _posts _drafts
        git commit -m "auto: sync wiki to blog" || echo "No changes"

        git push origin main
