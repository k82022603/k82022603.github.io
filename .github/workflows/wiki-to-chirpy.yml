- name: Convert Wiki to Chirpy posts
      run: |
        mkdir -p _posts _drafts
        NOW_TZ="+0900"

        for file in wiki/*.md; do
          # 1. 제목 추출 (첫 번째 # 헤더)
          TITLE=$(grep -m 1 "^# " "$file" | sed 's/^# //' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
          [ -z "$TITLE" ] && continue

          # 2. 메타데이터 추출
          PUBLISH=$(grep "@publish:" "$file" | awk '{print $2}')
          [ "$PUBLISH" = "false" ] && continue

          SLUG=$(grep "@slug:" "$file" | awk '{print $2}' | tr -d '[:space:]')
          if [ -z "$SLUG" ]; then
            # [파일명 최적화] 소문자 변환 후 알파벳, 숫자, 한글을 제외한 모든 특수문자를 하이픈(-)으로 변경
            SLUG=$(echo "$TITLE" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9가-힣ㄱ-ㅎㅏ-ㅣ]/-/g' | sed 's/--*/-/g' | sed 's/^-//;s/-$//')
          fi

          WIKI_DATE=$(grep "@date:" "$file" | awk '{print $2}')
          if [ -z "$WIKI_DATE" ]; then
            POST_DATE=$(date +"%Y-%m-%d")
            POST_DATETIME=$(date +"%Y-%m-%d %H:%M:%S $NOW_TZ")
          else
            POST_DATE="$WIKI_DATE"
            POST_DATETIME="$WIKI_DATE 09:00:00 $NOW_TZ"
          fi

          # 3. Mermaid 감지 로직
          if grep -q "```mermaid" "$file"; then
            MERMAID_FLAG="mermaid: true"
          else
            MERMAID_FLAG="mermaid: false"
          fi

          # 4. 카테고리/태그 및 경로 결정
          CATEGORIES=$(grep "@categories:" "$file" | cut -d':' -f2 | sed 's/,/, /g')
          TAGS=$(grep "@tags:" "$file" | cut -d':' -f2 | sed 's/,/, /g')
          DRAFT=$(grep "@draft:" "$file" | awk '{print $2}')
          
          if [ "$DRAFT" = "true" ]; then
            TARGET="_drafts/${SLUG}.md"
          else
            TARGET="_posts/${POST_DATE}-${SLUG}.md"
          fi

          # 5. 파일 생성 (Front Matter 주입)
          {
            echo "---"
            echo "title: \"$(echo "$TITLE" | sed 's/"/\\"/g')\""
            echo "date: $POST_DATETIME"
            echo "categories: [${CATEGORIES:-Wiki}]"
            echo "tags: [${TAGS:-Wiki}]"
            echo "$MERMAID_FLAG"
            echo "---"
            echo ""
          } > "$TARGET"

          # 6. 본문 주입 (메타데이터 및 첫 번째 제목 제외)
          sed '/^/d;/^@/d;1,/^# /d' "$file" >> "$TARGET"
        done