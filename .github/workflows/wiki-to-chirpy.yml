name: Sync Wiki to Chirpy Blog

on:
  push:
    branches: [ main ]
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

jobs:
  wiki-to-blog:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout blog repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Clone Wiki repository
      run: |
        echo "=== Cloning Wiki repository ==="
        git clone https://github.com/${{ github.repository }}.wiki.git wiki-temp
        
        if [ -d "wiki-temp" ]; then
          echo "âœ“ Wiki repository cloned successfully"
          echo ""
          echo "Wiki files found:"
          ls -la wiki-temp/*.md 2>/dev/null || echo "No markdown files found"
        else
          echo "âœ— Failed to clone wiki repository"
          echo "Please check if Wiki is enabled in repository settings"
          exit 1
        fi

    - name: Convert Wiki to Chirpy posts
      run: |
        echo ""
        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘   Wiki to Chirpy Blog Conversion      â•‘"
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        
        mkdir -p _posts _drafts
        NOW_TZ="+0900"
        
        CONVERTED_COUNT=0
        DRAFT_COUNT=0
        SKIPPED_COUNT=0
        ERROR_COUNT=0
        
        for file in wiki-temp/*.md; do
          [ -f "$file" ] || continue
          
          FILENAME=$(basename "$file")
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“„ Processing: $FILENAME"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # ë©”íƒ€ë°ì´í„°ì—ì„œ ì œëª© ì¶”ì¶œ
          META_TITLE=$(grep "^@title:" "$file" | cut -d':' -f2- | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
          
          if [ -n "$META_TITLE" ]; then
            TITLE="$META_TITLE"
            echo "ğŸ“Œ Title (from metadata): $TITLE"
          else
            # ì²« ë²ˆì§¸ # í—¤ë”ì—ì„œ ì œëª© ì¶”ì¶œ (ë§í¬ ì œê±°)
            TITLE=$(grep -m 1 "^# " "$file" | \
              sed 's/^# //' | \
              sed 's/\[#\]([^)]*)//g' | \
              sed 's/\[\[.*\]\]//g' | \
              sed 's/\[.*\]([^)]*)//g' | \
              sed 's/  */ /g' | \
              sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
            
            if [ -z "$TITLE" ]; then
              TITLE=$(basename "$file" .md)
              echo "âš ï¸  No title found, using filename: $TITLE"
            else
              echo "ğŸ“Œ Title (extracted): $TITLE"
            fi
          fi
          
          # ê³µê°œ ì—¬ë¶€ í™•ì¸
          PUBLISH=$(grep "^@publish:" "$file" | awk '{print $2}' | tr -d '[:space:]')
          if [ "$PUBLISH" = "false" ]; then
            echo "âŠ˜  Skipped (publish: false)"
            echo ""
            SKIPPED_COUNT=$((SKIPPED_COUNT + 1))
            continue
          fi
          
          # Slug ì²˜ë¦¬ (ê°œì„ ë¨!)
          SLUG=$(grep "^@slug:" "$file" | awk '{print $2}' | tr -d '[:space:]')
          
          if [ -z "$SLUG" ]; then
            echo "âš ï¸  No @slug specified, auto-generating..."
            
            # í•œê¸€ì„ ìœ ì§€í•˜ë©´ì„œ slug ìƒì„±
            SLUG=$(echo "$TITLE" | \
              tr '[:upper:]' '[:lower:]' | \
              sed 's/[^a-z0-9ê°€-í£]/-/g' | \
              sed 's/--*/-/g' | \
              sed 's/^-//;s/-$//')
            
            # slugê°€ ë¹„ì–´ìˆê±°ë‚˜ í•˜ì´í”ˆë§Œ ìˆìœ¼ë©´ íŒŒì¼ëª… ì‚¬ìš©
            if [ -z "$SLUG" ] || [ "$SLUG" = "-" ]; then
              SLUG=$(basename "$file" .md | tr '[:upper:]' '[:lower:]')
              echo "âš ï¸  Empty slug, using filename: $SLUG"
            fi
            
            # í•œê¸€ì´ í¬í•¨ë˜ì–´ ìˆìœ¼ë©´ ê²½ê³ 
            if echo "$SLUG" | grep -q '[ê°€-í£]'; then
              echo "âš ï¸  Korean characters in slug: $SLUG"
              echo "   ğŸ’¡ Recommendation: Add @slug: your-english-slug to Wiki"
            else
              echo "ğŸ”— Slug (auto-generated): $SLUG"
            fi
          else
            echo "ğŸ”— Slug (from metadata): $SLUG"
          fi
          
          # ë‚ ì§œ ì²˜ë¦¬
          WIKI_DATE=$(grep "^@date:" "$file" | awk '{print $2}')
          if [ -z "$WIKI_DATE" ]; then
            POST_DATE=$(date +"%Y-%m-%d")
            POST_DATETIME=$(date +"%Y-%m-%d %H:%M:%S $NOW_TZ")
            echo "ğŸ“… Date (current): $POST_DATE"
          else
            POST_DATE="$WIKI_DATE"
            POST_DATETIME="$WIKI_DATE 09:00:00 $NOW_TZ"
            echo "ğŸ“… Date (from wiki): $POST_DATE"
          fi
          
          # ì¹´í…Œê³ ë¦¬ ì¶”ì¶œ
          CATEGORIES=$(grep "^@categories:" "$file" | cut -d':' -f2 | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | sed 's/,/, /g')
          if [ -z "$CATEGORIES" ]; then
            CATEGORIES="Wiki"
            echo "ğŸ“ Categories (default): $CATEGORIES"
          else
            echo "ğŸ“ Categories: $CATEGORIES"
          fi
          
          # íƒœê·¸ ì¶”ì¶œ
          TAGS=$(grep "^@tags:" "$file" | cut -d':' -f2 | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | sed 's/,/, /g')
          if [ -n "$TAGS" ]; then
            echo "ğŸ·ï¸  Tags: $TAGS"
          fi
          
          # Draft ì—¬ë¶€ í™•ì¸
          DRAFT=$(grep "^@draft:" "$file" | awk '{print $2}' | tr -d '[:space:]')
          
          # íŒŒì¼ ê²½ë¡œ ê²°ì •
          if [ "$DRAFT" = "true" ]; then
            TARGET="_drafts/${SLUG}.md"
            echo "ğŸ“ Type: Draft"
            echo "ğŸ’¾ Output: $TARGET"
            DRAFT_COUNT=$((DRAFT_COUNT + 1))
          else
            TARGET="_posts/${POST_DATE}-${SLUG}.md"
            echo "ğŸ“ Type: Post"
            echo "ğŸ’¾ Output: $TARGET"
            CONVERTED_COUNT=$((CONVERTED_COUNT + 1))
          fi
          
          # Front Matter ìƒì„±
          {
            echo "---"
            echo "title: \"$TITLE\""
            echo "date: $POST_DATETIME"
            echo "categories: [$CATEGORIES]"
            if [ -n "$TAGS" ]; then
              echo "tags: [$TAGS]"
            fi
            echo "---"
            echo ""
          } > "$TARGET"
          
          # ë³¸ë¬¸ ë‚´ìš© ì¶”ê°€
          sed '/^<!--/,/^-->/d;/^@/d;1,/^# /d' "$file" >> "$TARGET"
          
          echo "âœ… Converted successfully"
          echo ""
        done
        
        rm -rf wiki-temp
        
        echo ""
        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘        Conversion Summary              â•‘"
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo "  ğŸ“Š Statistics:"
        echo "  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
        echo "  âœ… Posts created    : $CONVERTED_COUNT"
        echo "  ğŸ“ Drafts created   : $DRAFT_COUNT"
        echo "  âŠ˜  Files skipped    : $SKIPPED_COUNT"
        echo "  âŒ Errors           : $ERROR_COUNT"
        echo "  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
        echo "  ğŸ“ˆ Total processed  : $((CONVERTED_COUNT + DRAFT_COUNT + SKIPPED_COUNT + ERROR_COUNT))"
        echo ""

    - name: Commit and push changes
      run: |
        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘         Git Operations                 â•‘"
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
        git add _posts/ _drafts/
        
        echo "ğŸ“‹ Git Status:"
        echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
        git status --short
        echo ""
        
        if git diff --staged --quiet; then
          echo "âœ“ No changes to commit"
          echo "  Wiki content is already up to date"
          echo ""
        else
          echo "ğŸ“ Changed Files:"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          git diff --staged --name-status
          echo ""
          
          COMMIT_MSG="auto: sync wiki to blog [$(date +'%Y-%m-%d %H:%M:%S')]"
          
          echo "ğŸ’¾ Committing changes..."
          git commit -m "$COMMIT_MSG"
          
          echo "ğŸš€ Pushing to repository..."
          git push origin main
          
          echo ""
          echo "âœ… Wiki sync completed successfully!"
        fi

    - name: Workflow Summary
      if: always()
      run: |
        echo ""
        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘          Workflow Complete             â•‘"
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo "  Repository  : ${{ github.repository }}"
        echo "  Workflow    : ${{ github.workflow }}"
        echo "  Run ID      : ${{ github.run_id }}"
        echo "  Triggered by: ${{ github.event_name }}"
        echo "  Status      : ${{ job.status }}"
        echo ""
        echo "  ğŸ“… Completed at: $(date +'%Y-%m-%d %H:%M:%S')"
        echo ""
